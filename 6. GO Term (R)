#---------------------------------------GO-Term---------------------------------
#----------------------------------gene-conversion------------------------------
res_sig <- res %>%
  as.data.frame() %>%
  filter(padj < 0.05)  
res_sig$gene <- rownames(res_sig)

#annotate with real gene names
library(clusterProfiler)
library(org.Dm.eg.db)

gene_conversion <- bitr(res_sig$gene,
                        fromType = "FLYBASE",
                        toType = "ENTREZID",
                        OrgDb = org.Dm.eg.db)

#merge conversion with DE table
res_sig <- merge(res_sig, gene_conversion,
                 by.x = "gene", by.y = "FLYBASE")

#split gene sets
all_genes <- rownames(res_sig)
up_genes <- rownames(res_sig[res_sig$log2FoldChange > 0, ])
down_genes <- rownames(res_sig[res_sig$log2FoldChange < 0, ])

#map entrez ids to gene sets
all_entrez <- bitr(all_genes, fromType = "FLYBASE",
                   toType = "ENTREZID", OrgDb = org.Dm.eg.db)
up_entrez <- bitr(up_genes, fromType = "FLYBASE",
                  toType = "ENTREZID", OrgDb = org.Dm.eg.db)
down_entrez <- bitr(down_genes, fromType = "FLYBASE",
                    toType = "ENTREZID", OrgDb = org.Dm.eg.db)
head(all_entrez)

#-------------------------------------run-GO-Term-------------------------------
#now run GO Term analysis
#for all DEGs
ego_all <- enrichGO(
    gene = all_entrez$ENTREZID,
    OrgDb = org.Dm.eg.db,
    keyType = "ENTREZID",
    ont = "BP",
    pAdjustMethod = "BH",
    pvalueCutoff = 0.1,
    readable = TRUE
)

#for upregulated DEGs
ego_up <- enrichGO(
    gene = up_entrez$ENTREZID,
    OrgDb = org.Dm.eg.db,
    keyType = "ENTREZID",
    ont = "BP",
    pAdjustMethod = "BH",
    pvalueCutoff = 0.1,
    readable = TRUE
)

#for downregulated DEGs
ego_down <- enrichGO(
    gene = down_entrez$ENTREZID,
    OrgDb = org.Dm.eg.db,
    keyType = "ENTREZID",
    ont = "BP",
    pAdjustMethod = "BH",
    pvalueCutoff = 0.1,
    readable = TRUE
)


#---------------------------------Specialised-GO-Term---------------------------
#filter GO Terms by specific keywords for each theme
library(dplyr)
library(GO.db)

#metabolism
metabolism_root <- "GO:0008152"
metabolism_descendants <- unique(unlist(GOBPOFFSPRING[[metabolism_root]]))
metabolism_go_ids <- c(metabolism_root, metabolism_descendants)

#all DEGs
ego_all_metabolism <- ego_all@result %>%
  filter(ID %in% metabolism_go_ids) %>%
  filter(Count >= 3)

#upregulated DEGs
ego_up_metabolism <- ego_up@result %>%
  filter(ID %in% metabolism_go_ids) %>%
  filter(Count >= 3)

#downregulated DEGs
ego_down_metabolism <- ego_down@result %>%
  filter(ID %in% metabolism_go_ids) %>%
  filter(Count >= 3)

#immune
immune_root <- "GO:0002376"
immune_descendants <- unique(unlist(GOBPOFFSPRING[[immune_root]]))
immune_go_ids <- c(immune_root, immune_descendants)

#all DEGs
ego_all_immune <- ego_all@result %>%
  filter(ID %in% immune_go_ids) %>%
  filter(Count >= 3)

#upregulated DEGs
ego_up_immune <- ego_up@result %>%
  filter(ID %in% immune_go_ids) %>%
  filter(Count >= 3)

#downregulated DEGs
ego_down_immune <- ego_down@result %>%
  filter(ID %in% immune_go_ids) %>%
  filter(Count >= 3)

#oxidative stress
oxstress_root <- "GO:0006979"
oxstress_descendants <- unique(unlist(GOBPOFFSPRING[[oxstress_root]]))
oxstress_go_ids <- c(oxstress_root, oxstress_descendants)

#all DEGs
ego_all_oxstress <- ego_all@result %>%
  filter(ID %in% oxstress_go_ids) %>%
  filter(Count >= 3)

#upregulated DEGs
ego_up_oxstress <- ego_up@result %>%
  filter(ID %in% oxstress_go_ids) %>%
  filter(Count >= 3)

#downregulated DEGs
ego_down_oxstress <- ego_down@result %>%
  filter(ID %in% oxstress_go_ids) %>%
  filter(Count >= 3)

#--------------------------------Background-GO-Term-----------------------------
#background genes 
background_genes <- rownames(count_data_filtered)  

#convert to Entrez IDs
background_genes_entrez <- bitr(background_genes,
                                fromType = "FLYBASE",
                                toType = "ENTREZID",
                                OrgDb = org.Dm.eg.db)$ENTREZID

#upregulated genes
ego_up <- enrichGO(
  gene = up_genes,
  OrgDb = org.Dm.eg.db,
  keyType = "ENTREZID",
  ont = "BP",
  universe = background_genes_entrez,  
  pAdjustMethod = "BH",
  pvalueCutoff = 0.1,
  qvalueCutoff = 0.2
)

#downregulated genes
ego_down <- enrichGO(
  gene = down_genes,
  OrgDb = org.Dm.eg.db,
  keyType = "ENTREZID",
  ont = "BP",
  universe = background_genes_entrez, 
  pAdjustMethod = "BH",
  pvalueCutoff = 0.1,
  qvalueCutoff = 0.2
)










#------------------------------Specialised-GO-Term-2----------------------------

#filter GO Terms by specific keywords for each theme
#metabolism
keywords_metabolism <- c(
  "metabol",      # metabolism, metabolic
  "glycol",       # glycolysis
  "lipid",        # lipid metabolism
  "fatty acid",
  "carbohydrate",
  "amino acid",
  "energy",
  "catabol",      # catabolism
  "anabol"        # anabolism
)
metabolism_regex <- paste(keywords_metabolism, collapse = "|")

#immune
keywords_immune <- c(
  "immune",
  "defense",
  "response to bacter",
  "response to virus",
  "inflamm",
  "Toll",
  "IMD",
  "antimicrob",
  "cytokine",
  "chemokine",
  "interfer",
  "interleukin",
  "lymphocyte",
  "leukocyte",
  "phagocyt",
  "antigen",
  "complement",
  "adaptive",
  "innate"
)
immune_regex <- paste(keywords_immune, collapse = "|")

#oxidative stress
keywords_oxidative <- c(
  "oxidative",
  "ROS",
  "reactive oxygen",
  "redox",
  "peroxid",
  "superoxide",
  "antioxidant"
)
oxidative_regex <- paste(keywords_oxidative, collapse = "|")

#upregulated metabolism
ego_up_metabolism <- ego_up@result %>%
  filter(grepl(metabolism_regex, Description, ignore.case = TRUE))
#upregulated immune
ego_up_immune <- ego_up@result %>%
  filter(grepl(immune_regex, Description, ignore.case = TRUE))
#upregulated oxidative stress
ego_up_oxidative <- ego_up@result %>%
  filter(grepl(oxidative_regex, Description, ignore.case = TRUE))

#downregulated metabolism
ego_down_metabolism <- ego_down@result %>%
  filter(grepl(metabolism_regex, Description, ignore.case = TRUE))
ego_down_immune <- ego_down@result %>%
  filter(grepl(immune_regex, Description, ignore.case = TRUE))
ego_down_oxidative <- ego_down@result %>%
  filter(grepl(oxidative_regex, Description, ignore.case = TRUE))

#visualise
#upregulated metabolism 
ggplot(ego_up_metabolism, aes(x = reorder(Description, -p.adjust), y = -log10(p.adjust))) +
  geom_bar(stat = "identity", fill = "#E41A1C") +
  coord_flip() +
  theme_bw() +
  labs(y = "-log10(FDR)", x = "GO Term", title = "Upregulated Metabolism GO Terms")
ggplot(ego_up_metabolism, aes(x = Count, y = -log10(p.adjust), size = Count)) +
  geom_point(color = "#E41A1C", alpha = 0.7) +
  geom_text(aes(label = Description), check_overlap = TRUE, hjust = 0.5) +
  theme_bw() +
  labs(x = "Gene Count", y = "-log10(FDR)", title = "Upregulated Metabolism GO Term Enrichment")

#upregulated immune 
ggplot(ego_up_immune, aes(x = reorder(Description, -p.adjust), y = -log10(p.adjust))) +
  geom_bar(stat = "identity", fill = "#E41A1C") +
  coord_flip() +
  theme_bw() +
  labs(y = "-log10(FDR)", x = "GO Term", title = "Upregulated Immune GO Terms")
ggplot(ego_up_immune, aes(x = Count, y = -log10(p.adjust), size = Count)) +
  geom_point(color = "#E41A1C", alpha = 0.7) +
  geom_text(aes(label = Description), check_overlap = TRUE, hjust = 0.5) +
  theme_bw() +
  labs(x = "Gene Count", y = "-log10(FDR)", title = "Upregulated Immune GO Term Enrichment")

#upregulated oxidative 
ggplot(ego_up_oxidative, aes(x = reorder(Description, -p.adjust), y = -log10(p.adjust))) +
  geom_bar(stat = "identity", fill = "#E41A1C") +
  coord_flip() +
  theme_bw() +
  labs(y = "-log10(FDR)", x = "GO Term", title = "Upregulated Oxidative GO Terms")
ggplot(ego_up_oxidative, aes(x = Count, y = -log10(p.adjust), size = Count)) +
  geom_point(color = "#E41A1C", alpha = 0.7) +
  geom_text(aes(label = Description), check_overlap = TRUE, hjust = 0.5) +
  theme_bw() +
  labs(x = "Gene Count", y = "-log10(FDR)", title = "Upregulated Oxidative GO Term Enrichment")

#export
write.csv(ego_up_metabolism, "GO_Up_Metabolism.csv", row.names = FALSE)
write.csv(ego_up_immune, "GO_Up_Immune.csv", row.names = FALSE)
write.csv(ego_up_oxidative, "GO_Up_Oxidative.csv", row.names = FALSE)
write.csv(ego_down_metabolism, "GO_Down_Metabolism.csv", row.names = FALSE)
