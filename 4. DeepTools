#install DeepTools

conda install -c conda-forge -c bioconda deeptools

#or

pip install deeptools

#make sure to have .bai index files before proceeding
samtools index 1.bam

#convert .bam files to .bw

#sample 1
bamCoverage \
    -b 1.bam \
    -o 1.bw \
    --normalizeUsing CPM \
    --binSize 25 \
    --extendReads

#make bed file
awk 'BEGIN{OFS="\t"} $3=="gene"{print $1,$4-1,$5,$10}' BDGP6.54.115.gtf | sed 's/"//g; s/;//g' > genes.bed

#summarise .bam files
multiBamSummary BED-file \
  --bamfiles 1.bam 2.bam 3.bam 4.bam 5.bam 6.bam 7.bam 8.bam \
  --BED genes.bed \
  --outFileName bam_summary_genes.npz \
  --outRawCounts raw_counts_genes.tab \
  --numberOfProcessors 4

#plot a correlation map
plotCorrelation \
  -in bam_summary_genes.npz \
  --corMethod spearman \
  --whatToPlot heatmap \
  --plotNumbers \
  --colorMap Blues \
  --zMin 0 --zMax 1 \
  --plotTitle "Sample Correlation (Spearman, Blue)" \
  -o correlation_heatmap_blue.png \
  -o correlation_values_spearman.tab \
  --removeOutliers

#plot PCA analysis
plotPCA -in bam_summary_genes.npz -o pca_plot.png -T "PCA of samples"
